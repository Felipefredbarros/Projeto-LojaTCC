<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:composition template="/index.xhtml">
        <ui:define name="body">

            <h:form id="form" styleClass="form-container">
                <p:growl id="mdialog" showDetail="true" globalOnly="true"/>

                <p:panel header="Cadastro de Vendas" styleClass="form-card">

                    <h3 class="section-title">Informações da Venda</h3>

                    <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank ui-fluid"
                                 columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4">

                        <p:outputLabel value="Data da Venda:" styleClass="font-semibold"/>
                        <p:calendar id="dataVenda" value="#{vendaControle.venda.dataVenda}"
                                    pattern="dd/MM/yyyy" locale="pt_BR" />

                        <p:outputLabel value="Cliente:" styleClass="font-semibold"/>
                        <p:autoComplete id="cliente" value="#{vendaControle.venda.cliente}"
                                        converter="#{vendaControle.pessoaConverter}"
                                        completeMethod="#{vendaControle.getListaClientesFiltrando}"
                                        var="cli"
                                        itemLabel="#{cli.nome}" itemValue="#{cli}" />

                        <p:outputLabel value="Funcionario:" styleClass="font-semibold"/>
                        <p:autoComplete id="funcionario" value="#{vendaControle.venda.funcionario}"
                                        converter="#{vendaControle.pessoaConverter}"
                                        completeMethod="#{vendaControle.getListaFuncionariosFiltrando}"
                                        var="forc"
                                        itemLabel="#{forc.nome}" itemValue="#{forc}" />

                        <p:outputLabel value="Plano de Pagamento:" styleClass="font-semibold"/>
                        <p:selectOneMenu id="plano" value="#{vendaControle.venda.planoPagamento}">
                            <f:selectItems value="#{vendaControle.planosPagamentos}" var="plano"
                                           itemLabel="#{plano.descricao}" itemValue="#{plano}" />
                            <p:ajax listener="#{vendaControle.atualizarMetodosPagamento}"
                                    update="metodos parcelasWrapper" />
                        </p:selectOneMenu>

                        <p:outputLabel value="Metodo de Pagamento:" styleClass="font-semibold"/>
                        <p:selectOneMenu id="metodos" value="#{vendaControle.venda.metodoPagamento}">
                            <f:selectItems value="#{vendaControle.metodosPagamentoFiltrados}" var="metodo"
                                           itemLabel="#{metodo.descricao}" itemValue="#{metodo}" />
                        </p:selectOneMenu>
                    </p:panelGrid>

                    <p:outputPanel id="parcelasWrapper" style="display: block; margin-top: 15px;">
                        <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank ui-fluid"
                                     columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4"
                                     rendered="#{not empty vendaControle.venda.planoPagamento and vendaControle.venda.planoPagamento eq 'FIADO'}">

                            <p:outputLabel for="parcelas" value="Parcelas:" styleClass="font-semibold"/>
                            <p:inputNumber id="parcelas" value="#{vendaControle.venda.parcelas}"
                                           minValue="1" maxValue="12" />

                            <p:outputLabel for="dataVencimento" value="Data de Vencimento" styleClass="font-semibold"/>
                            <p:calendar id="dataVencimento" value="#{vendaControle.venda.dataVencimento}"
                                        pattern="dd/MM/yyyy" locale="pt_BR" />
                        </p:panelGrid>
                    </p:outputPanel>


                    <h:panelGroup layout="block" rendered="#{!vendaControle.edit}">

                        <h3 class="section-title">Itens da Venda</h3>

                        <p:panelGrid columns="2"  styleClass="ui-panelgrid-blank ui-fluid grid-itens-apertado"
                                     >
                            <p:outputLabel value="Produto:" styleClass="font-semibold"/>
                            <p:selectOneMenu id="produto" value="#{vendaControle.itensVenda.produtoDerivacao}"
                                             converter="#{vendaControle.produtoDevConverter}" filter="true" filterMatchMode="contains">
                                <f:selectItems value="#{vendaControle.listaDerivacoes}" var="dev"
                                               itemLabel="#{dev.texto}" itemValue="#{dev}"/>
                                <p:ajax event="change" listener="#{vendaControle.atualizarPreco}"
                                        update="valorUnitario" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Preço:" styleClass="font-semibold"/>
                            <p:inputNumber id="valorUnitario" value="#{vendaControle.itensVenda.valorUnitario}"
                                           symbol="R$ " decimalSeparator="," thousandSeparator="." minValue="0"/>

                            <p:outputLabel value="Qtd:" styleClass="font-semibold"/>
                            <p:inputNumber id="quantidade" value="#{vendaControle.itensVenda.quantidade}"
                                           minValue="0" decimalPlaces="0" />

                        </p:panelGrid>

                        <p:commandButton value="Adicionar Item" icon="pi pi-plus" actionListener="#{vendaControle.adicionarItem()}"
                                         update="mdialog itensTable totalVenda"
                                         styleClass="p-mt-2 p-mb-2" style="margin-top: 10px; margin-bottom: 15px;"/>

                        <p:dataTable id="itensTable" value="#{vendaControle.venda.itensVenda}" var="item"
                                     emptyMessage="Nenhum item no carrinho" rows="5" paginator="true" scrollable="true" scrollHeight="165">
                            <p:column headerText="Produto">
                                <h:outputText value="#{item.produtoDerivacao.produto.categoria.categoria}" />
                            </p:column>
                            <p:column headerText="Quantidade" style="width: 100px; text-align: center">
                                <h:outputText value="#{item.quantidade}" />
                            </p:column>
                            <p:column headerText="Preço" style="width: 120px">
                                <h:outputText value="#{item.valorUnitario}">
                                    <f:convertNumber type="currency" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Subtotal" style="width: 120px">
                                <h:outputText value="#{item.subTotal}">
                                    <f:convertNumber type="currency" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Operações" style="width:100px;text-align:center">
                                <p:commandButton icon="pi pi-trash" title="Remover"
                                                 actionListener="#{vendaControle.removerItem(item)}"
                                                 update=":form:itensTable :form:totalVenda :form:mdialog"
                                                 process="@this"/>
                            </p:column>
                        </p:dataTable>

                        <p:panelGrid columns="2" layout="grid" style="width: 100%; margin-top: 20px;"
                                     columnClasses="ui-grid-col-8, ui-grid-col-4" 
                                     styleClass="total-grid">

                            <p:outputLabel value=""/> <h:panelGroup style="text-align: right; display: block;">
                                <p:outputLabel value="Total da Venda: " style="font-size: 1.5rem; font-weight: bold; color: #007bff; vertical-align: middle;"/>
                                <h:outputText id="totalVenda" value="#{vendaControle.venda.total}" style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; vertical-align: middle;">
                                    <f:convertNumber type="currency" />
                                </h:outputText>
                            </h:panelGroup>
                        </p:panelGrid>

                    </h:panelGroup>

                    <h:panelGroup layout="block" style="margin-top: 30px;">
                        <p:commandButton value="Salvar" actionListener="#{vendaControle.salvar()}"
                                         update="form mdialog" ajax="false" 
                                         icon="pi pi-save" style="margin-right: 10px"/>

                        <p:commandButton value="Cancelar" action="listaVenda.xhtml" immediate="true" ajax="false"
                                         icon="pi pi-times" styleClass="ui-button-secondary"/>
                    </h:panelGroup>

                </p:panel>
            </h:form>

            <style>
                body {
                    background-color: #f0f4f8;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }
                .form-container {
                    width: 100%;
                    max-width: 1300px;
                    margin-left: 40px;
                    margin-right: auto;
                    padding: 10px;
                }

                .form-card {
                    padding: 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    background-color: #ffffff;
                }

                /* Título do p:panel */
                .ui-panel-titlebar {
                    background-color: #007bff !important;
                    color: #fff !important;
                    font-weight: bold;
                    font-size: 18px;
                    padding: 12px 20px !important;
                    border-top-left-radius: 10px;
                    border-top-right-radius: 10px;
                    border: none !important;
                    box-shadow: none !important;
                }

                .font-semibold {
                    font-weight: 600;
                    color: #2c3e50;
                }

                .section-title {
                    margin-top: 30px;
                    margin-bottom: 10px;
                    font-size: 18px;
                    font-weight: bold;
                    color: #007bff;
                    border-bottom: 2px solid #007bff;
                    padding-bottom: 5px;
                }
                .ui-inputfield,
                .ui-selectonemenu-label,
                .ui-inputnumber .ui-inputfield {
                    border-radius: 6px !important;
                    padding: 8px 10px !important;
                }

                .ui-inputfield:focus,
                .ui-selectonemenu:focus,
                .ui-inputnumber .ui-inputfield:focus {
                    border-color: #007bff !important;
                    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25) !important;
                }

                .ui-button,
                .ui-button-info,
                .ui-button-success,
                .ui-button-secondary {
                    border-radius: 6px;
                    font-weight: 600;
                }

                /* Botão Salvar (Verde) - Ajustado para seu botão primário */
                .ui-button.ui-button-text-icon-left {
                    background-color: #28a745; /* Verde Sucesso */
                    border-color: #28a745;
                }
                .ui-button.ui-button-text-icon-left:hover {
                    background-color: #218838;
                    border-color: #1e7e34;
                }

                /* Ajuste para o botão Salvar da tela de Pessoa (Azul) */
                .ui-button-success {
                    background-color: #007bff;
                    border-color: #007bff;
                }

                .ui-button-success:hover {
                    background-color: #0056b3;
                    border-color: #004b9b;
                }

                .ui-button-secondary {
                    background-color: #6c757d;
                    border-color: #6c757d;
                }

                .ui-button-secondary:hover {
                    background-color: #5a6268;
                    border-color: #4e555b;
                }

                .ui-panelgrid .ui-panelgrid-cell {
                    padding: 0.5rem;
                }

                .total-grid.ui-panelgrid .ui-panelgrid-cell {
                    border-style: none !important;
                    padding-top: 10px;
                    padding-bottom: 0px;
                }

                .grid-itens-apertado.ui-panelgrid .ui-panelgrid-cell {
                    padding: 0.5rem 0.5rem;
                }

            </style>

        </ui:define>
    </ui:composition>
</html>